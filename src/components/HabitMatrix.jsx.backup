import { useMemo, useState, useEffect } from 'react';
import { ChevronLeft, ChevronRight, Calendar, Filter, TrendingUp, Award, Flame, Target, Search, Trash2, Edit } from 'lucide-react';

// Enhanced Monthly Habit Tracker with improved UX and analytics
function HabitMatrix({ habits, toggleDay, calculateStreak, deleteHabit }) {
  const today = new Date();
  const todayISO = today.toISOString().split('T')[0];
  const [viewDate, setViewDate] = useState(() => new Date(today.getFullYear(), today.getMonth(), 1));
  const year = viewDate.getFullYear();
  const month = viewDate.getMonth();

  // Enhanced UI state
  const [filter, setFilter] = useState('');
  const [weekStartsOn, setWeekStartsOn] = useState(1); // 1 = Monday (more user-friendly)
  const [selectedHabit, setSelectedHabit] = useState(null);
  const [viewMode, setViewMode] = useState('compact'); // 'compact' or 'detailed'
  
  // Context menu state
  const [contextMenu, setContextMenu] = useState(null);
  const [contextMenuHabit, setContextMenuHabit] = useState(null);

  // Responsive layout constants
  const TITLE_COL_WIDTH = viewMode === 'detailed' ? 280 : 220;
  const DAY_COL_WIDTH = viewMode === 'detailed' ? 36 : 30;
  const SUMMARY_COL_WIDTH = viewMode === 'detailed' ? 80 : 60;

  // Actual month day ISO strings (used for statistics & toggling)
  const monthDays = useMemo(() => {
    const list = [];
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    for (let d = 1; d <= daysInMonth; d++) {
      list.push(new Date(year, month, d).toISOString().split('T')[0]);
    }
    return list;
  }, [year, month]);

  // Calendar cells including leading & trailing filler days so all weeks have 7 columns
  const calendarCells = useMemo(() => {
    const cells = [];
    const firstOfMonth = new Date(year, month, 1);
    const startDay = firstOfMonth.getDay(); // 0 (Sun) ... 6 (Sat)
    // Normalize based on selected week start
    const startDayNormalized = (startDay - weekStartsOn + 7) % 7;
    const prevMonthLastDate = new Date(year, month, 0).getDate();

    // Leading fillers (previous month)
    for (let i = startDayNormalized - 1; i >= 0; i--) {
      const dateObj = new Date(year, month - 1, prevMonthLastDate - i);
      cells.push({ date: dateObj.toISOString().split('T')[0], isFiller: true, dayNumber: dateObj.getDate() });
    }

    // Current month days
    monthDays.forEach(dStr => {
      const dateObj = new Date(dStr);
      cells.push({ date: dStr, isFiller: false, dayNumber: dateObj.getDate() });
    });

    // Trailing fillers to complete last week
    const remainder = cells.length % 7;
    if (remainder !== 0) {
      const trailingCount = 7 - remainder;
      for (let i = 1; i <= trailingCount; i++) {
        const dateObj = new Date(year, month + 1, i);
        cells.push({ date: dateObj.toISOString().split('T')[0], isFiller: true, dayNumber: dateObj.getDate() });
      }
    }
    // Ensure fixed 6-week (42 cell) grid
    while (cells.length < 42) {
      const offset = cells.length - (monthDays.length + startDayNormalized);
      const dateObj = new Date(year, month + 1, offset + 1 + (remainder === 0 ? 0 : 0));
      cells.push({ date: dateObj.toISOString().split('T')[0], isFiller: true, dayNumber: dateObj.getDate() });
    }
    return cells;
  }, [monthDays, year, month, weekStartsOn]);

  // Chunk calendar cells into fixed 7-day weeks
  const weeks = useMemo(() => {
    const arr = [];
    for (let i = 0; i < calendarCells.length; i += 7) {
      arr.push(calendarCells.slice(i, i + 7));
    }
    return arr;
  }, [calendarCells]);

  // Filter habits by title
  const activeHabits = useMemo(() => {
    if (!filter.trim()) return habits;
    const q = filter.toLowerCase();
    return habits.filter(h => h.title.toLowerCase().includes(q));
  }, [habits, filter]);

  const completionByDay = useMemo(() => {
    // percent of habits completed for each day
    return monthDays.map(dStr => {
      const completed = activeHabits.filter(h => h.completedDates?.includes(dStr)).length;
      const percent = activeHabits.length ? Math.round((completed / activeHabits.length) * 100) : 0;
      return { date: dStr, percent, completed };
    });
  }, [monthDays, activeHabits]);

  // Close context menu on outside click
  useEffect(() => {
    const handleClick = () => setContextMenu(null);
    if (contextMenu) {
      document.addEventListener('click', handleClick);
      return () => document.removeEventListener('click', handleClick);
    }
  }, [contextMenu]);

  // Handle right-click context menu
  const handleContextMenu = (e, habit) => {
    e.preventDefault();
    setContextMenu({ x: e.clientX, y: e.clientY });
    setContextMenuHabit(habit);
  };

  // Handle delete habit
  const handleDeleteHabit = () => {
    if (contextMenuHabit && deleteHabit) {
      if (window.confirm(`Are you sure you want to delete "${contextMenuHabit.title}"?`)) {
        deleteHabit(contextMenuHabit.id);
      }
    }
    setContextMenu(null);
    setContextMenuHabit(null);
  };

  // Precompute completion sets for faster lookups
  const habitCompletionMap = useMemo(() => {
    return activeHabits.reduce((acc, h) => {
      acc[h.id] = new Set(h.completedDates || []);
      return acc;
    }, {});
  }, [activeHabits]);

  // Enhanced analytics calculations
  const overallProgress = useMemo(() => {
    const totalPossible = activeHabits.length * monthDays.length;
    let totalDone = 0;
    activeHabits.forEach(h => {
      totalDone += (h.completedDates?.filter(d => monthDays.includes(d)).length || 0);
    });
    return totalPossible ? Math.round((totalDone / totalPossible) * 100) : 0;
  }, [activeHabits, monthDays]);

  // Calculate best performing habits
  const topPerformers = useMemo(() => {
    return activeHabits
      .map(h => {
        const count = h.completedDates?.filter(d => monthDays.includes(d)).length || 0;
        const percent = monthDays.length ? Math.round((count / monthDays.length) * 100) : 0;
        const streak = calculateStreak ? calculateStreak(h.completedDates) : 0;
        return { ...h, monthlyPercent: percent, monthlyCount: count, currentStreak: streak };
      })
      .sort((a, b) => b.monthlyPercent - a.monthlyPercent)
      .slice(0, 3);
  }, [activeHabits, monthDays, calculateStreak]);

  // Calculate consistency score (based on daily completion variance)
  const consistencyScore = useMemo(() => {
    if (monthDays.length === 0) return 0;
    const dailyCompletions = monthDays.map(d => 
      activeHabits.filter(h => h.completedDates?.includes(d)).length
    );
    const avg = dailyCompletions.reduce((a, b) => a + b, 0) / monthDays.length;
    const variance = dailyCompletions.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / monthDays.length;
    const stdDev = Math.sqrt(variance);
    const consistency = avg > 0 ? Math.max(0, 100 - (stdDev / avg) * 100) : 0;
    return Math.round(consistency);
  }, [monthDays, activeHabits]);

  // Best and worst days
  const dayPerformance = useMemo(() => {
    const performance = monthDays.map(d => {
      const completed = activeHabits.filter(h => h.completedDates?.includes(d)).length;
      const percent = activeHabits.length ? Math.round((completed / activeHabits.length) * 100) : 0;
      return { date: d, completed, percent, dayName: new Date(d).toLocaleDateString('en-US', { weekday: 'long' }) };
    });
    const sorted = [...performance].sort((a, b) => b.percent - a.percent);
    return {
      best: sorted[0],
      worst: sorted[sorted.length - 1],
      allDays: performance
    };
  }, [monthDays, activeHabits]);

  // Per-habit summary (count & percent across month)
  const habitSummaries = useMemo(() => {
    return activeHabits.map(h => {
      const count = h.completedDates?.filter(d => monthDays.includes(d)).length || 0;
      const percent = monthDays.length ? Math.round((count / monthDays.length) * 100) : 0;
      return { id: h.id, count, percent };
    });
  }, [activeHabits, monthDays]);

  // Weekly totals based on calendar weeks (exclude filler days)
  const weeklyTotals = useMemo(() => {
    return weeks.map(weekCells => {
      const realDays = weekCells.filter(c => !c.isFiller).map(c => c.date);
      if (!realDays.length) return { completed: 0, percent: 0 };
      const completedCount = realDays.reduce((daySum, d) => {
        const done = activeHabits.filter(h => habitCompletionMap[h.id].has(d)).length;
        return daySum + done;
      }, 0);
      const possible = activeHabits.length * realDays.length;
      const percent = possible ? Math.round((completedCount / possible) * 100) : 0;
      return { completed: completedCount, percent };
    });
  }, [weeks, activeHabits, habitCompletionMap]);

  // Heatmap color for completed cell based on streak length
  const getStreakClass = (streak) => {
    if (streak >= 21) return 'bg-indigo-700';
    if (streak >= 14) return 'bg-indigo-600';
    if (streak >= 7) return 'bg-indigo-500';
    if (streak >= 3) return 'bg-indigo-400';
    return 'bg-indigo-300';
  };

  return (
    <div className="space-y-4">
      {/* Enhanced Header with Analytics Cards */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
        {/* Main Progress Card */}
        <div className="lg:col-span-2 bg-gradient-to-br from-indigo-600/20 to-purple-600/20 dark:from-indigo-600/20 dark:to-purple-600/20 border border-indigo-500/30 dark:border-indigo-500/30 rounded-xl p-4 sm:p-6">
          <div className="flex items-start justify-between mb-4">
            <div>
              <div className="flex items-center gap-2 mb-2">
                <Calendar className="w-5 h-5 text-indigo-400 dark:text-indigo-400" />
                <h3 className="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">
                  {viewDate.toLocaleString('en-US', { month: 'long' })} {year}
                </h3>
              </div>
              <p className="text-sm text-gray-600 dark:text-zinc-400">
                {activeHabits.length} active {activeHabits.length === 1 ? 'habit' : 'habits'} â€¢ {monthDays.length} days tracked
              </p>
            </div>
            {/* Month Navigation */}
            <div className="flex items-center gap-1">
              <button
                onClick={() => setViewDate(d => new Date(d.getFullYear(), d.getMonth() - 1, 1))}
                className="p-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-zinc-800/50 dark:hover:bg-zinc-700/50 text-gray-700 dark:text-zinc-300 transition-colors"
                aria-label="Previous month"
              >
                <ChevronLeft className="w-4 h-4" />
              </button>
              <button
                onClick={() => setViewDate(new Date(today.getFullYear(), today.getMonth(), 1))}
                className="px-3 py-2 text-xs rounded-lg bg-indigo-600 hover:bg-indigo-500 dark:bg-indigo-600 dark:hover:bg-indigo-500 text-white font-medium transition-colors"
              >
                Today
              </button>
              <button
                onClick={() => setViewDate(d => new Date(d.getFullYear(), d.getMonth() + 1, 1))}
                className="p-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-zinc-800/50 dark:hover:bg-zinc-700/50 text-gray-700 dark:text-zinc-300 transition-colors"
                aria-label="Next month"
              >
                <ChevronRight className="w-4 h-4" />
              </button>
            </div>
          </div>

          {/* Progress Bar */}
          <div className="space-y-2">
            <div className="flex items-center justify-between text-sm">
              <span className="text-gray-600 dark:text-zinc-400">Overall Completion</span>
              <span className="text-2xl font-bold text-gray-900 dark:text-white">{overallProgress}%</span>
            </div>
            <div className="h-4 bg-gray-200 dark:bg-black/30 rounded-full overflow-hidden">
              <div 
                className="h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 transition-all duration-500 rounded-full"
                style={{ width: `${overallProgress}%` }}
              />
            </div>
            <div className="flex items-center justify-between text-xs text-gray-600 dark:text-zinc-400">
              <span>{activeHabits.reduce((s,h)=> s + (h.completedDates?.filter(d=>monthDays.includes(d)).length || 0),0)} completed</span>
              <span>{activeHabits.length * monthDays.length} total possible</span>
            </div>
          </div>
        </div>

        {/* Quick Stats Card */}
        <div className="grid grid-cols-2 lg:grid-cols-1 gap-3">
          <div className="bg-gray-50 dark:bg-zinc-900/50 border border-gray-200 dark:border-zinc-800 rounded-xl p-4">
            <div className="flex items-center gap-2 mb-2">
              <div className="p-2 bg-indigo-100 dark:bg-indigo-600/20 rounded-lg">
                <TrendingUp className="w-4 h-4 text-indigo-600 dark:text-indigo-400" />
              </div>
              <span className="text-xs text-gray-600 dark:text-zinc-400">Consistency</span>
            </div>
            <div className="text-2xl font-bold text-gray-900 dark:text-white">{consistencyScore}%</div>
            <p className="text-xs text-gray-500 dark:text-zinc-500 mt-1">
              {consistencyScore >= 80 ? 'Excellent!' : consistencyScore >= 60 ? 'Good work' : 'Keep pushing'}
            </p>
          </div>

          <div className="bg-gray-50 dark:bg-zinc-900/50 border border-gray-200 dark:border-zinc-800 rounded-xl p-4">
            <div className="flex items-center gap-2 mb-2">
              <div className="p-2 bg-orange-100 dark:bg-orange-600/20 rounded-lg">
                <Flame className="w-4 h-4 text-orange-600 dark:text-orange-400" />
              </div>
              <span className="text-xs text-gray-600 dark:text-zinc-400">Best Streak</span>
            </div>
            <div className="text-2xl font-bold text-gray-900 dark:text-white">
              {Math.max(...activeHabits.map(h => calculateStreak ? calculateStreak(h.completedDates) : 0))}
            </div>
            <p className="text-xs text-gray-500 dark:text-zinc-500 mt-1">days in a row</p>
          </div>
        </div>
      </div>

      {/* Top Performers Section */}
      {topPerformers.length > 0 && (
        <div className="bg-gray-50 dark:bg-zinc-900/50 border border-gray-200 dark:border-zinc-800 rounded-xl p-4">
          <div className="flex items-center gap-2 mb-3">
            <Award className="w-5 h-5 text-yellow-600 dark:text-yellow-400" />
            <h4 className="text-sm font-semibold text-gray-900 dark:text-white">Top Performers This Month</h4>
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
            {topPerformers.map((habit, idx) => (
              <div 
                key={habit.id}
                className="bg-white dark:bg-zinc-800/50 border border-gray-200 dark:border-zinc-700 rounded-lg p-3 hover:border-indigo-500/50 transition-all"
              >
                <div className="flex items-start justify-between mb-2">
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium text-gray-900 dark:text-white truncate">{habit.title}</p>
                    <p className="text-xs text-gray-600 dark:text-zinc-400 mt-1">
                      {habit.monthlyCount} / {monthDays.length} days
                    </p>
                  </div>
                  <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
                    idx === 0 ? 'bg-yellow-500/20 text-yellow-400' :
                    idx === 1 ? 'bg-zinc-400/20 text-zinc-300' :
                    'bg-orange-500/20 text-orange-400'
                  }`}>
                    {idx + 1}
                  </div>
                </div>
                <div className="flex items-center justify-between">
                  <div className="flex-1 h-2 bg-gray-200 dark:bg-zinc-700 rounded-full overflow-hidden mr-2">
                    <div 
                      className={`h-full ${
                        idx === 0 ? 'bg-yellow-500' :
                        idx === 1 ? 'bg-zinc-400' :
                        'bg-orange-500'
                      }`}
                      style={{ width: `${habit.monthlyPercent}%` }}
                    />
                  </div>
                  <span className="text-sm font-bold text-gray-900 dark:text-white">{habit.monthlyPercent}%</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Controls Bar */}
      <div className="bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl p-3 sm:p-4">
        <div className="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center justify-between">
          {/* Search & Filter */}
          <div className="flex-1 flex gap-2">
            <div className="relative flex-1 max-w-xs">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 dark:text-zinc-500" />
              <input
                type="text"
                value={filter}
                onChange={e => setFilter(e.target.value)}
                placeholder="Search habits..."
                className="w-full bg-gray-100 dark:bg-zinc-800 border border-gray-300 dark:border-zinc-700 rounded-lg pl-9 pr-3 py-2 text-sm text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500/50"
              />
            </div>
            <button
              onClick={() => setViewMode(m => m === 'compact' ? 'detailed' : 'compact')}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                viewMode === 'detailed'
                  ? 'bg-indigo-600 text-white dark:bg-indigo-600 dark:text-white'
                  : 'bg-gray-200 dark:bg-zinc-800 text-gray-700 dark:text-zinc-300 hover:bg-gray-300 dark:hover:bg-zinc-700'
              }`}
            >
              {viewMode === 'detailed' ? 'Compact' : 'Detailed'}
            </button>
          </div>

          {/* Week Start Toggle */}
          <label className="flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-zinc-800 border border-gray-300 dark:border-zinc-700 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-zinc-700 transition-colors">
            <input
              type="checkbox"
              checked={weekStartsOn === 1}
              onChange={() => setWeekStartsOn(prev => prev === 0 ? 1 : 0)}
              className="w-4 h-4 accent-indigo-600 cursor-pointer"
            />
            <span className="text-sm text-gray-700 dark:text-zinc-300">Start week on Monday</span>
          </label>
        </div>

        {/* Active Filters */}
        {filter && (
          <div className="mt-3 pt-3 border-t border-gray-200 dark:border-zinc-800">
            <div className="flex items-center gap-2">
              <Filter className="w-4 h-4 text-indigo-600 dark:text-indigo-400" />
              <span className="text-xs text-gray-600 dark:text-zinc-400">
                Showing {activeHabits.length} of {habits.length} habits
              </span>
              <button
                onClick={() => setFilter('')}
                className="text-xs text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 dark:hover:text-indigo-300 transition-colors"
              >
                Clear filter
              </button>
            </div>
          </div>
        )}
      </div>

      {/* Matrix Table */}
      <div className="bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl p-3 sm:p-4 overflow-x-auto">
        <div className="min-w-max">
        {/* Week Group Row (each always spans 7 days) */}
        <div className="grid text-[10px] sm:text-xs font-medium" style={{ gridTemplateColumns: `${TITLE_COL_WIDTH}px repeat(${calendarCells.length}, ${DAY_COL_WIDTH}px) ${SUMMARY_COL_WIDTH}px` }}>
          <div className="px-3 py-1 text-zinc-400 sticky left-0 bg-zinc-900 z-20" role="columnheader">My Habits</div>
          {weeks.map((w, idx) => (
            <div
              key={idx}
              className="px-1 py-1 text-center bg-gray-100 dark:bg-zinc-800/40 rounded-sm border border-gray-300 dark:border-zinc-700"
              style={{ gridColumn: 'span 7' }}
            >
              Week {idx + 1}
            </div>
          ))}
          <div className="px-2 py-1 text-center text-gray-600 dark:text-zinc-400 border border-gray-300 dark:border-zinc-700 bg-gray-100 dark:bg-zinc-800/40" role="columnheader">Total</div>
        </div>
        {/* Day Name Row */}
        <div className="grid text-[9px] sm:text-[10px]" style={{ gridTemplateColumns: `${TITLE_COL_WIDTH}px repeat(${calendarCells.length}, ${DAY_COL_WIDTH}px) ${SUMMARY_COL_WIDTH}px` }}>
          <div className="px-3 sticky left-0 bg-white dark:bg-zinc-900 z-20 border-r-2 border-gray-300 dark:border-zinc-700"></div>
          {calendarCells.map(cell => (
            <div key={cell.date} className={`text-center py-1 font-extrabold uppercase tracking-wider ${cell.isFiller ? 'text-gray-300 dark:text-zinc-800' : 'text-gray-800 dark:text-zinc-200'} ${(new Date(cell.date).getDay() === 0 || new Date(cell.date).getDay() === 6) && !cell.isFiller ? 'bg-blue-50 dark:bg-blue-900/20 rounded-sm text-blue-800 dark:text-blue-200 border border-blue-300 dark:border-blue-700' : ''}`}>
              {new Date(cell.date).toLocaleDateString('en-US', { weekday: 'short' }).slice(0,2)}
            </div>
          ))}
          <div className="px-2"></div>
        </div>
        {/* Day Number Row */}
        <div className="grid text-[9px] sm:text-[10px]" style={{ gridTemplateColumns: `${TITLE_COL_WIDTH}px repeat(${calendarCells.length}, ${DAY_COL_WIDTH}px) ${SUMMARY_COL_WIDTH}px` }}>
          <div className="px-3 py-1 text-[11px] sm:text-xs text-gray-800 dark:text-zinc-200 font-bold sticky left-0 bg-white dark:bg-zinc-900 z-20 border-r-2 border-gray-300 dark:border-zinc-700">&nbsp;</div>
          {calendarCells.map(cell => (
            <div key={cell.date} className={`text-center font-bold ${cell.isFiller ? 'text-gray-300 dark:text-zinc-700' : 'text-gray-700 dark:text-zinc-200'}`}>
              {cell.dayNumber}
            </div>
          ))}
          <div className="px-2 py-1 text-center text-[10px] text-gray-800 dark:text-zinc-200 font-extrabold">%</div>
        </div>
        {/* Habit Rows with Enhanced Design */}
        {activeHabits.length === 0 ? (
          <div className="col-span-full py-12 text-center">
            <Target className="w-12 h-12 text-gray-400 dark:text-zinc-600 mx-auto mb-3" />
            <p className="text-gray-600 dark:text-zinc-400">
              {filter ? 'No habits match your search' : 'No habits yet. Add one to get started!'}
            </p>
          </div>
        ) : (
          activeHabits.map(habit => {
            const streak = calculateStreak ? calculateStreak(habit.completedDates) : 0;
            const summary = habitSummaries.find(s => s.id === habit.id);
            const isSelected = selectedHabit === habit.id;
            
            return (
              <div
                key={habit.id}
                className={`grid border-t border-gray-200 dark:border-zinc-800 transition-all ${
                  isSelected 
                    ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-300 dark:border-indigo-700' 
                    : 'hover:bg-gray-50 dark:hover:bg-zinc-800/40'
                }`}
                role="row"
                style={{ gridTemplateColumns: `${TITLE_COL_WIDTH}px repeat(${calendarCells.length}, ${DAY_COL_WIDTH}px) ${SUMMARY_COL_WIDTH}px` }}
              >
                {/* Habit Title Cell */}
                <div 
                  className="text-xs text-gray-900 dark:text-white px-3 py-2 flex items-center justify-between gap-2 overflow-hidden sticky left-0 bg-white dark:bg-zinc-900 z-10 cursor-pointer group border-r-2 border-gray-300 dark:border-zinc-700 shadow-sm"
                  onContextMenu={(e) => handleContextMenu(e, habit)}
                  onClick={() => setSelectedHabit(isSelected ? null : habit.id)}
                  title={`${habit.title} - Click for details`}
                  role="rowheader"
                >
                  <div className="flex items-center gap-2 min-w-0 flex-1">
                    <span className="text-lg filter drop-shadow-sm">{habit.title.match(/^[\p{Emoji}\p{Extended_Pictographic}]+/u)?.[0] || 'ðŸ“Œ'}</span>
                    <span className="truncate font-semibold group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">
                      {habit.title.replace(/^[\p{Emoji}\p{Extended_Pictographic}]+\s*/u, '')}
                    </span>
                  </div>
                  {streak > 0 && (
                    <div className="flex items-center gap-1 px-2 py-0.5 bg-orange-500/20 rounded-full text-[10px] text-orange-400 font-bold whitespace-nowrap">
                      <Flame className="w-3 h-3" />
                      {streak}
                    </div>
                  )}
                </div>

                {/* Day Cells */}
                {calendarCells.map(cell => {
                  if (cell.isFiller) {
                    return (
                      <div
                        key={cell.date}
                        className="m-[2px] rounded bg-gray-300/30 dark:bg-zinc-950/50"
                      />
                    );
                  }
                  const d = cell.date;
                  const completed = habitCompletionMap[habit.id]?.has(d);
                  const isToday = d === todayISO;
                  const dateObj = new Date(d);
                  const isFutureDate = dateObj > today;
                  const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;
                  
                  // Honest Tracking Rules - STRICT MODE:
                  // 1. ONLY TODAY can be marked/unmarked
                  // 2. Past dates are PERMANENTLY LOCKED (no backdating ever)
                  // 3. Future dates are always disabled
                  // This prevents ALL forms of cheating - you must mark habits on the actual day
                  const isPastDate = dateObj < today && !isToday;
                  const isDisabled = isFutureDate || isPastDate; // Lock ALL past and future dates
                  
                  return (
                    <button
                      key={d}
                      onClick={() => !isDisabled && toggleDay?.(habit.id, d)}
                      disabled={isDisabled}
                      className={`m-[0.5px] flex items-center justify-center rounded transition-all text-xs font-extrabold focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-offset-white dark:focus:ring-offset-zinc-900 focus:ring-indigo-500 relative group/day border-2 ${
                        completed 
                          ? `${getStreakClass(streak)} text-white shadow-[0_2px_8px_rgba(0,0,0,0.2),inset_0_-1px_2px_rgba(0,0,0,0.2)] dark:shadow-[0_2px_12px_rgba(0,0,0,0.5),inset_0_-1px_3px_rgba(0,0,0,0.3)] border-transparent ${!isDisabled && 'hover:scale-110 hover:z-10 hover:shadow-[0_4px_16px_rgba(0,0,0,0.3),inset_0_-1px_3px_rgba(0,0,0,0.3)] dark:hover:shadow-[0_4px_20px_rgba(0,0,0,0.7),inset_0_-1px_4px_rgba(0,0,0,0.4)]'}` 
                          : `bg-gradient-to-b from-white to-gray-50 dark:from-zinc-800 dark:to-zinc-850 text-gray-700 dark:text-zinc-300 border-gray-500 dark:border-zinc-500 shadow-[inset_0_1px_2px_rgba(255,255,255,0.8),0_1px_3px_rgba(0,0,0,0.1)] dark:shadow-[inset_0_1px_2px_rgba(255,255,255,0.05),0_1px_3px_rgba(0,0,0,0.3)] ${!isDisabled && 'hover:bg-gradient-to-b hover:from-indigo-50 hover:to-indigo-100 dark:hover:from-indigo-900/30 dark:hover:to-indigo-900/20 hover:border-indigo-600 dark:hover:border-indigo-500 hover:text-indigo-800 dark:hover:text-indigo-200 hover:shadow-[0_0_0_2px_rgba(99,102,241,0.4)]'}`
                      } ${
                        isDisabled 
                          ? 'opacity-40 cursor-not-allowed' 
                          : 'cursor-pointer'
                      } ${
                        isToday ? 'ring-[3px] ring-yellow-400 dark:ring-yellow-500 ring-offset-1 ring-offset-white dark:ring-offset-zinc-900 animate-pulse !shadow-[0_0_0_5px_rgba(251,191,36,0.3),0_2px_8px_rgba(251,191,36,0.4)]' : ''
                      } ${
                        isPastDate && !completed ? '!bg-gray-100 dark:!bg-zinc-900 !border-gray-600 dark:!border-zinc-500' : ''
                      } ${
                        isWeekend && !completed && !isDisabled ? 'bg-gradient-to-b from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-900/10 border-blue-500 dark:border-blue-600' : ''
                      }`}
                      title={`${dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', weekday: 'short' })}\n${completed ? 'âœ“ Completed' : 'Not completed'}${
                        isFutureDate ? '\nðŸ”’ Future date (locked)' : 
                        isPastDate ? '\nðŸ”’ Past date (permanently locked)' : 
                        isToday ? '\nâ­ Today - Mark your progress NOW!' : ''
                      }`}
                      aria-label={`${dateObj.toLocaleDateString()} - ${completed ? 'Completed' : 'Not completed'}${isPastDate || isFutureDate ? ' (locked)' : ''}`}
                      aria-pressed={completed}
                    >
                      {completed && viewMode === 'detailed' && 'âœ“'}
                      {completed && viewMode === 'compact' && <div className="w-1.5 h-1.5 bg-white rounded-full" />}
                      {isToday && !completed && (
                        <div className="absolute inset-0 bg-yellow-400/10 rounded animate-pulse" />
                      )}
                      {isPastDate && !completed && (
                        <div className="absolute inset-0 flex items-center justify-center text-[8px] text-gray-500 dark:text-zinc-600">ðŸ”’</div>
                      )}
                    </button>
                  );
                })}

                {/* Summary Cell */}
                <div 
                  className="flex flex-col items-center justify-center text-[10px] font-extrabold bg-gradient-to-b from-indigo-100 to-indigo-50 dark:from-indigo-900/40 dark:to-indigo-900/20 border-2 border-indigo-400 dark:border-indigo-600 rounded-md mx-[2px] gap-1 py-1 shadow-[0_2px_8px_rgba(99,102,241,0.2)] dark:shadow-[0_2px_12px_rgba(99,102,241,0.3)]" 
                  role="cell" 
                  aria-label={`Monthly completion ${summary?.percent || 0}%`}
                >
                  {viewMode === 'detailed' ? (
                    <>
                      <div className="text-base font-bold text-gray-900 dark:text-white">{summary?.percent || 0}%</div>
                      <div className="w-full px-2">
                        <div className="h-1.5 bg-gray-300 dark:bg-zinc-700 rounded-full overflow-hidden">
                          <div 
                            className="h-full bg-gradient-to-r from-indigo-500 to-purple-500" 
                            style={{ width: `${summary?.percent || 0}%` }} 
                          />
                        </div>
                      </div>
                      <div className="text-gray-600 dark:text-zinc-400">{summary?.count}/{monthDays.length}</div>
                    </>
                  ) : (
                    <>
                      <div className="text-sm font-bold text-indigo-600 dark:text-indigo-400">{summary?.percent || 0}%</div>
                      <div className="text-gray-500 dark:text-zinc-500 text-[9px]">{summary?.count}</div>
                    </>
                  )}
                </div>
              </div>
            );
          })
        )}
        {/* Progress row (daily percent + overall) */}
        <div
          className="grid border-t border-gray-200 dark:border-zinc-800"
          style={{ gridTemplateColumns: `${TITLE_COL_WIDTH}px repeat(${calendarCells.length}, ${DAY_COL_WIDTH}px) ${SUMMARY_COL_WIDTH}px` }}
        >
          <div className="text-[10px] uppercase tracking-wide text-gray-700 dark:text-zinc-300 font-bold px-3 py-1 sticky left-0 bg-white dark:bg-zinc-900 z-10 border-r-2 border-gray-300 dark:border-zinc-700">% Done</div>
          {calendarCells.map(cell => {
            if (cell.isFiller) {
              return <div key={cell.date} className="text-[10px] text-center text-gray-300 dark:text-zinc-700"></div>;
            }
            const data = completionByDay.find(cd => cd.date === cell.date);
            const intensity = data ? Math.min(100, data.percent) : 0;
            const bgClass = intensity >= 80 ? 'bg-gradient-to-b from-emerald-100 to-emerald-50 dark:from-emerald-900/40 dark:to-emerald-900/20 text-emerald-800 dark:text-emerald-300 font-bold border border-emerald-300 dark:border-emerald-700' : intensity >= 60 ? 'bg-gradient-to-b from-indigo-100 to-indigo-50 dark:from-indigo-900/40 dark:to-indigo-900/20 text-indigo-800 dark:text-indigo-300 font-bold border border-indigo-300 dark:border-indigo-700' : intensity >= 40 ? 'bg-gradient-to-b from-blue-50 to-blue-25 dark:from-blue-900/30 dark:to-blue-900/15 text-blue-700 dark:text-blue-300 font-semibold border border-blue-200 dark:border-blue-700' : intensity >= 20 ? 'bg-gradient-to-b from-amber-50 to-amber-25 dark:from-amber-900/30 dark:to-amber-900/15 text-amber-700 dark:text-amber-300 font-semibold border border-amber-200 dark:border-amber-700' : 'text-gray-500 dark:text-zinc-500 border border-gray-200 dark:border-zinc-700';
            return (
              <div key={cell.date} className={`text-[10px] text-center rounded-sm py-0.5 m-[0.5px] ${bgClass}`} aria-label={`Day ${new Date(cell.date).getDate()} percent ${data?.percent ?? 0}`}>{data?.percent ?? 0}</div>
            );
          })}
          <div className="flex flex-col items-center justify-center text-[10px] font-black text-indigo-800 dark:text-indigo-200 bg-gradient-to-b from-indigo-100 to-indigo-50 dark:from-indigo-900/40 dark:to-indigo-900/20 border-2 border-indigo-400 dark:border-indigo-600 rounded-sm shadow-sm" aria-label={`Overall monthly progress ${overallProgress}%`}>
            <span className="text-sm">{overallProgress}%</span>
            <span className="text-gray-700 dark:text-zinc-300 font-semibold">All</span>
          </div>
        </div>
        {/* Weekly totals row */}
        <div
          className="grid border-t border-gray-200 dark:border-zinc-800"
          style={{ gridTemplateColumns: `${TITLE_COL_WIDTH}px repeat(${calendarCells.length}, ${DAY_COL_WIDTH}px) ${SUMMARY_COL_WIDTH}px` }}
        >
          <div className="text-[10px] uppercase tracking-wide text-gray-700 dark:text-zinc-300 font-bold px-3 py-1 sticky left-0 bg-white dark:bg-zinc-900 z-10 border-r-2 border-gray-300 dark:border-zinc-700">Week %</div>
          {weeks.map((w, idx) => {
            const { percent } = weeklyTotals[idx];
            return (
              <div key={idx} className="text-[10px] text-center text-indigo-700 dark:text-indigo-300 font-bold bg-indigo-50/50 dark:bg-indigo-900/10 rounded-sm" style={{ gridColumn: `span 7` }} aria-label={`Week ${idx + 1} percent ${percent}`}>{percent}%</div>
            );
          })}
          <div className="text-[10px] text-center text-indigo-800 dark:text-indigo-200 font-bold bg-indigo-50 dark:bg-indigo-900/20 rounded-sm" aria-label="Overall weeks percent">{overallProgress}%</div>
        </div>
        </div>
      </div>

      {/* Enhanced Legend & Tips */}
      <div className="bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl p-4">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* Color Legend */}
          <div>
            <h4 className="text-sm font-semibold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
              <div className="w-1 h-4 bg-gradient-to-b from-indigo-500 to-purple-500 rounded-full" />
              Streak Colors
            </h4>
            <div className="grid grid-cols-2 gap-2">
              <div className="flex items-center gap-2 text-xs text-gray-600 dark:text-zinc-400">
                <span className="w-6 h-6 rounded bg-indigo-300 flex items-center justify-center text-white text-[10px] font-bold">âœ“</span>
                <span>1-2 days</span>
              </div>
              <div className="flex items-center gap-2 text-xs text-gray-600 dark:text-zinc-400">
                <span className="w-6 h-6 rounded bg-indigo-400 flex items-center justify-center text-white text-[10px] font-bold">âœ“</span>
                <span>3-6 days</span>
              </div>
              <div className="flex items-center gap-2 text-xs text-gray-600 dark:text-zinc-400">
                <span className="w-6 h-6 rounded bg-indigo-500 flex items-center justify-center text-white text-[10px] font-bold">âœ“</span>
                <span>7-13 days</span>
              </div>
              <div className="flex items-center gap-2 text-xs text-gray-600 dark:text-zinc-400">
                <span className="w-6 h-6 rounded bg-indigo-600 flex items-center justify-center text-white text-[10px] font-bold">âœ“</span>
                <span>14-20 days</span>
              </div>
              <div className="flex items-center gap-2 text-xs text-gray-600 dark:text-zinc-400">
                <span className="w-6 h-6 rounded bg-indigo-700 flex items-center justify-center text-white text-[10px] font-bold">âœ“</span>
                <span>21+ days</span>
              </div>
              <div className="flex items-center gap-2 text-xs text-gray-600 dark:text-zinc-400">
                <span className="w-6 h-6 rounded bg-gray-100 dark:bg-zinc-800/80 border border-gray-300 dark:border-zinc-700/50 flex items-center justify-center text-gray-500 dark:text-zinc-500">Ã—</span>
                <span>Incomplete</span>
              </div>
              <div className="flex items-center gap-2 text-xs text-gray-600 dark:text-zinc-400">
                <span className="w-6 h-6 rounded bg-gray-200 dark:bg-zinc-900 border border-gray-400/50 dark:border-zinc-700/30 flex items-center justify-center text-[10px]">ðŸ”’</span>
                <span>Locked (past)</span>
              </div>
            </div>
          </div>

          {/* Quick Tips */}
          <div>
            <h4 className="text-sm font-semibold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
              <div className="w-1 h-4 bg-gradient-to-b from-yellow-500 to-orange-500 rounded-full" />
              Quick Tips
            </h4>
            <ul className="space-y-1.5 text-xs text-gray-600 dark:text-zinc-400">
              <li className="flex items-start gap-2">
                <span className="text-indigo-600 dark:text-indigo-400 mt-0.5">â€¢</span>
                <span><span className="text-gray-900 dark:text-white">Click any day</span> to mark habit as complete</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-yellow-600 dark:text-yellow-400 mt-0.5">â€¢</span>
                <span><span className="text-gray-900 dark:text-white">Yellow rings</span> indicate today's date</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-orange-600 dark:text-orange-400 mt-0.5">â€¢</span>
                <span><span className="text-gray-900 dark:text-white">Flame badges</span> show current streaks</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-purple-600 dark:text-purple-400 mt-0.5">â€¢</span>
                <span><span className="text-gray-900 dark:text-white">Darker colors</span> mean longer streaks</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-red-600 dark:text-red-400 mt-0.5">â€¢</span>
                <span><span className="text-gray-900 dark:text-white">ONLY TODAY</span> can be marked - past dates permanently locked (100% honest tracking)</span>
              </li>
            </ul>
          </div>
        </div>

        {/* Context Menu */}
        {contextMenu && (
          <div
            className="fixed bg-white dark:bg-zinc-800 border-2 border-gray-300 dark:border-zinc-600 rounded-lg shadow-[0_8px_32px_rgba(0,0,0,0.25)] dark:shadow-[0_8px_40px_rgba(0,0,0,0.5)] py-2 z-50 min-w-[180px]"
            style={{ top: contextMenu.y, left: contextMenu.x }}
            onClick={(e) => e.stopPropagation()}
          >
            <div className="px-3 py-2 border-b border-gray-200 dark:border-zinc-700">
              <p className="text-xs font-bold text-gray-900 dark:text-white truncate">
                {contextMenuHabit?.title}
              </p>
            </div>
            <button
              onClick={handleDeleteHabit}
              className="w-full px-3 py-2 text-left text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2 transition-colors font-medium"
            >
              <Trash2 size={16} />
              Delete Habit
            </button>
            <button
              onClick={() => setContextMenu(null)}
              className="w-full px-3 py-2 text-left text-sm text-gray-600 dark:text-zinc-400 hover:bg-gray-50 dark:hover:bg-zinc-700/50 flex items-center gap-2 transition-colors font-medium border-t border-gray-200 dark:border-zinc-700"
            >
              Cancel
            </button>
          </div>
        )}

        {/* Performance Insights */}
        {dayPerformance.best && (
          <div className="mt-4 pt-4 border-t border-gray-200 dark:border-zinc-800">
            <h4 className="text-sm font-semibold text-gray-900 dark:text-white mb-2">This Month's Insights</h4>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div className="bg-emerald-50 dark:bg-emerald-500/10 border border-emerald-200 dark:border-emerald-500/30 rounded-lg p-3">
                <div className="flex items-center gap-2 mb-1">
                  <TrendingUp className="w-4 h-4 text-emerald-600 dark:text-emerald-400" />
                  <span className="text-xs font-medium text-emerald-600 dark:text-emerald-400">Best Day</span>
                </div>
                <p className="text-sm text-gray-900 dark:text-white font-semibold">
                  {new Date(dayPerformance.best.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} â€¢ {dayPerformance.best.dayName}
                </p>
                <p className="text-xs text-gray-600 dark:text-zinc-400 mt-1">
                  {dayPerformance.best.completed} habits completed ({dayPerformance.best.percent}%)
                </p>
              </div>
              <div className="bg-gray-50 dark:bg-zinc-800/50 border border-gray-200 dark:border-zinc-700 rounded-lg p-3">
                <div className="flex items-center gap-2 mb-1">
                  <Target className="w-4 h-4 text-gray-600 dark:text-zinc-400" />
                  <span className="text-xs font-medium text-gray-600 dark:text-zinc-400">Needs Focus</span>
                </div>
                <p className="text-sm text-gray-900 dark:text-white font-semibold">
                  {new Date(dayPerformance.worst.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} â€¢ {dayPerformance.worst.dayName}
                </p>
                <p className="text-xs text-gray-600 dark:text-zinc-400 mt-1">
                  {dayPerformance.worst.completed} habits completed ({dayPerformance.worst.percent}%)
                </p>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

export default HabitMatrix;
